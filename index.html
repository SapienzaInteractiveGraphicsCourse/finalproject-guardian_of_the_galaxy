<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Guardian of the Galaxy</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<link type="text/css" rel="stylesheet" href="./files/main.css">
	</head>
	<body>

		<div id="container"></div>
		<div id="info">
		<a href="http://threejs.org" target="_blank" rel="noopener">Guardian of the Galaxy</a>
		</div>
		<script src="node_modules/three/build/three.min.js"></script>
		<script src="three.js"></script>
		<script src="GLTFLoader.js"></script>
		<script src="OBJLoader.js"></script>
		<script src="MTLLoader.js"></script>
		<script src="THREEx.KeyboardState.js"></script>
		<style type="text/css">
			body {
			overflow: hidden;
			}
		</style>
		<script type="module">

			import Stats from './jsm/libs/stats.module.js';

			import { GUI } from './jsm/libs/dat.gui.module.js';
			import { OrbitControls } from './jsm/controls/OrbitControls.js';

			var container, stats;
			var camera, scene, renderer, light;
			var controls;

			var raycaster = new THREE.Raycaster();
			var mouse = new THREE.Vector2();


			// Meshes index
			var meshes = {};

			var clock = new THREE.Clock();
			var keyboard = new THREEx.KeyboardState();



			// Bullets array
			var bullets = [];
			var objects = [];


			var models = {
				starship: {
					mesh: null
				},
				enemystarship: {
					mesh: null
				}
			};


			init();
			animate();


			function init() {

				container = document.getElementById( 'container' );

				//
				renderer = new THREE2.WebGLRenderer();
				renderer.setPixelRatio( window.devicePixelRatio );
				renderer.setSize( window.innerWidth, window.innerHeight );
				container.appendChild( renderer.domElement );


				var loadManager = new THREE.LoadingManager();
				// 
				var textureLoader = new THREE.TextureLoader(loadManager);

				//var backgroundImageTexture = textureLoader.load("images/space.jpg");


				camera = new THREE2.PerspectiveCamera( 40, window.innerWidth / window.innerHeight, 1, 2000 );
				camera.position.set( 0.0, 18.0, 40.0 );
				scene = new THREE2.Scene();
				//scene.background = backgroundImageTexture; 
				scene.background= new THREE.Color( 0xffffff );

   				camera.lookAt( scene.position );


   				//----LIGHT------

				var ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
				scene.add(ambientLight);

				var light= new THREE.PointLight(0xFFFFFF);
				light.position.set(-100,200,100);

				scene.add(light);

   				//---------------




				//----MODELS-----


				var starship_loader = new THREE.OBJLoader();
				var starship_mtlLoader = new THREE.MTLLoader();

				starship_mtlLoader.load('images/starship/star-wars-x-wing.mtl', (materials) => {
					materials.preload();
					starship_loader.setMaterials(materials);
					starship_loader.load('images/starship/star-wars-x-wing.obj', (object) => {
						object.position.set(0,3,-10);
						scene.add(object);
						models["starship"].mesh = object;
						meshes["starship"] = models.starship.mesh.clone();
						object.name ="starship"
						object.traverse( function ( child ) {
							if ( child instanceof THREE.Mesh ) {
								child.castShadow = true;
							}
						} );
						objects.push(object);
					});
				});


				var enemies_obj_loader = new THREE.OBJLoader();
				var enemies_mtlLoader = new THREE.MTLLoader();

				enemies_mtlLoader.load('images/enemies/star-wars-vader-tie-fighter-big.mtl', (materials) => {
					materials.preload();
					enemies_obj_loader.setMaterials(materials);
					enemies_obj_loader.load('images/enemies/star-wars-vader-tie-fighter-big.obj', (object) => {
						object.position.set(0.5,2.0,-20);
						scene.add(object);
						models["enemystarship"].mesh = object;
						meshes["enemystarship"] = models.enemystarship.mesh.clone();
						object.name ="enemystarship"
						object.traverse( function ( child ) {
							if ( child instanceof THREE.Mesh ) {
								child.castShadow = true;
							}
						} );
						objects.push(object);
						//console.log(meshes["enemystarship"]);
					});
				});







				//controls
				controls = new OrbitControls( camera, renderer.domElement);
				controls.maxPolarAngle = Math.PI * 4;
				controls.target.set( 0, 10, 0 );
				controls.minDistance = 40.0;
				controls.maxDistance = 400.0;
				controls.update();

				//

				stats = new Stats();
				container.appendChild( stats.dom );



				window.addEventListener( 'resize', onWindowResize, false );

   


			}

			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();
				renderer.setSize( window.innerWidth, window.innerHeight );

			}

			function animate() {



				requestAnimationFrame( animate );



				for(var index=0; index < bullets.length; index+=1){
					if( bullets[index] === undefined ) continue;
					if( bullets[index].alive == false ){
						bullets.splice(index,1);
						continue;
					}
					bullets[index].position.add(bullets[index].velocity);
				}


				// shoot a bullet
				if(keyboard.pressed(" ")){ // spacebar key
					// creates a bullet as a Mesh object
					var bullet_dx = new THREE.Mesh(
						new THREE.SphereGeometry(0.2,20,20),
						new THREE.MeshBasicMaterial({color:0xff8c000})
					);
					// this is silly.
					// var bullet = models.pirateship.mesh.clone();

					// position the bullet to come from the player's weapon
					bullet_dx.position.set(
						models["starship"].mesh.position.x + 2.9,
						models["starship"].mesh.position.y - 1.0,
						models["starship"].mesh.position.z + 10
					);

					// set the velocity of the bullet
					bullet_dx.velocity = new THREE.Vector3(
						-Math.sin(camera.rotation.y),
						0,
						-Math.cos(camera.rotation.y)
					);

					// after 1000ms, set alive to false and remove from scene
					// setting alive to false flags our update code to remove
					// the bullet from the bullets array
					bullet_dx.alive = true;
					setTimeout(function(){
						bullet_dx.alive = false;
						scene.remove(bullet_dx);
					}, 1000);

					// add to scene, array, and set the delay to 10 frames
					bullets.push(bullet_dx);
					scene.add(bullet_dx);

					var bullet_sx = new THREE.Mesh(
						new THREE.SphereGeometry(0.2,20,20),
						new THREE.MeshBasicMaterial({color:0xff8c000})
					);
					// this is silly.
					// var bullet = models.pirateship.mesh.clone();

					// position the bullet to come from the player's weapon
					bullet_sx.position.set(
						models["starship"].mesh.position.x - 0.4,
						models["starship"].mesh.position.y - 1.0,
						models["starship"].mesh.position.z + 10
					);

					// set the velocity of the bullet
					bullet_sx.velocity = new THREE.Vector3(
						-Math.sin(camera.rotation.y),
						0,
						-Math.cos(camera.rotation.y)
					);

					// after 1000ms, set alive to false and remove from scene
					// setting alive to false flags our update code to remove
					// the bullet from the bullets array
					bullet_sx.alive = true;
					setTimeout(function(){
						bullet_sx.alive = false;
						scene.remove(bullet_sx);
					}, 1000);

					// add to scene, array, and set the delay to 10 frames
					bullets.push(bullet_sx);
					scene.add(bullet_sx);
					objects.push(bullet_dx);
					objects.push(bullet_sx);

				}

				if ( keyboard.pressed("D") ){
					models["starship"].mesh.translateX(0.2);
					meshes["starship"] = models.starship.mesh.clone();
				}

				if ( keyboard.pressed("A") ){
					models["starship"].mesh.translateX(-0.2);
					meshes["starship"] = models.starship.mesh.clone();
				}
				if ( keyboard.pressed("W") ){
					models["starship"].mesh.translateY(0.2);
					meshes["starship"] = models.starship.mesh.clone();
				}
				if ( keyboard.pressed("S") ){
					models["starship"].mesh.translateY(-0.2);
					meshes["starship"] = models.starship.mesh.clone();   
				}

				render();
				update();

			}

			function onMouseMove( event ) {

				// calculate mouse position in normalized device coordinates
				// (-1 to +1) for both components

				mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
				mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;

			}

			window.addEventListener( 'mousemove', onMouseMove, false );



			function update(){
				controls.update();
				stats.update();
			}


			function render() {

				// update the picking ray with the camera and mouse position
				raycaster.setFromCamera(mouse, camera );

				// calculate objects intersecting the picking ray
				var intersects = raycaster.intersectObjects( objects, true );

				for ( var i = 0; i < intersects.length; i++ ) {
					if (intersects[i].object.parent != undefined){
						if (intersects[i].object.parent.name == "enemystarship"){
							console.log("headshot");
							//var removeObject = scene.getObjectByName(intersects[i].object.parent.name)
							//scene.remove(removeObject);	
						}
					}
				}

				var time = performance.now() * 0.001;
				renderer.render( scene, camera );

			}

		</script>
	</body>
</html>